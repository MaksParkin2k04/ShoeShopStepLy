@page
@using ShoeShop.Models
@model ShoeShop.Pages.Admin.StatisticsModel
@{
    ViewData["Title"] = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
    <a asp-page="/Admin/Index" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
    </a>
</div>

@* –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–∞–º *@
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞</h6>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">–° –¥–∞—Ç—ã</label>
                <input type="date" name="fromDate" class="form-control" value="@Model.FromDate?.ToString("yyyy-MM-dd")">
            </div>
            <div class="col-md-4">
                <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
                <input type="date" name="toDate" class="form-control" value="@Model.ToDate?.ToString("yyyy-MM-dd")">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="?" class="btn btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>
</div>

@* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ *@
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">@Model.Statistics.TotalQuantitySold</h5>
                <p class="card-text">–ü—Ä–æ–¥–∞–Ω–æ –ø–∞—Ä</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">@Model.Statistics.TotalRevenue.ToString("F2") ‚ÇΩ</h5>
                <p class="card-text">–í—ã—Ä—É—á–∫–∞</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger">@Model.Statistics.TotalCosts.ToString("F2") ‚ÇΩ</h5>
                <p class="card-text">–ó–∞—Ç—Ä–∞—Ç—ã</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">@Model.Statistics.NetProfit.ToString("F2") ‚ÇΩ</h5>
                <p class="card-text">–ü—Ä–∏–±—ã–ª—å</p>
            </div>
        </div>
    </div>
</div>

@* –ì—Ä–∞—Ñ–∏–∫–∏ *@
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6>–í—ã—Ä—É—á–∫–∞ vs –ó–∞—Ç—Ä–∞—Ç—ã</h6>
            </div>
            <div class="card-body">
                <canvas id="revenueChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6>–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ</h6>
            </div>
            <div class="card-body">
                <canvas id="productsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

@* –¢–∞–±–ª–∏—Ü–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º *@
<div class="card mt-4">
    <div class="card-header">
        <h6>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º</h6>
    </div>
    <div class="card-body">
        @if (Model.ProductStatistics.Any()) {
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ü—Ä–æ–¥–∞–Ω–æ –ø–∞—Ä</th>
                            <th>–í—ã—Ä—É—á–∫–∞</th>
                            <th>–ó–∞—Ç—Ä–∞—Ç—ã</th>
                            <th>–ü—Ä–∏–±—ã–ª—å</th>
                            <th>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.ProductStatistics) {
                            var profitMargin = product.Costs > 0 ? (product.Profit / product.Costs) * 100 : 0;
                            <tr>
                                <td>@product.ProductName</td>
                                <td>@product.QuantitySold</td>
                                <td>@product.Revenue.ToString("F2") ‚ÇΩ</td>
                                <td>@product.Costs.ToString("F2") ‚ÇΩ</td>
                                <td class="@(product.Profit >= 0 ? "text-success" : "text-danger")">@product.Profit.ToString("F2") ‚ÇΩ</td>
                                <td class="@(profitMargin >= 0 ? "text-success" : "text-danger")">@profitMargin.ToString("F1")%</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        } else {
            <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏ vs –∑–∞—Ç—Ä–∞—Ç
const revenueCtx = document.getElementById('revenueChart').getContext('2d');
new Chart(revenueCtx, {
    type: 'doughnut',
    data: {
        labels: ['–ü—Ä–∏–±—ã–ª—å', '–ó–∞—Ç—Ä–∞—Ç—ã'],
        datasets: [{
            data: [@Model.Statistics.NetProfit, @Model.Statistics.TotalCosts],
            backgroundColor: ['#28a745', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// –ì—Ä–∞—Ñ–∏–∫ —Ç–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
const productsCtx = document.getElementById('productsChart').getContext('2d');
const topProducts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProductStatistics.Take(5).Select(p => new { name = p.ProductName, revenue = p.Revenue })));
new Chart(productsCtx, {
    type: 'bar',
    data: {
        labels: topProducts.map(p => p.name),
        datasets: [{
            label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
            data: topProducts.map(p => p.revenue),
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>

@* AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å —Å–æ–≤–µ—Ç–∞–º–∏ *@
<div class="card mt-4">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0">
            <i class="fas fa-robot me-2"></i>AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–¥–∞–∂
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            @{
                var aiProfitMargin = Model.Statistics.TotalCosts > 0 ? (Model.Statistics.NetProfit / Model.Statistics.TotalCosts) * 100 : 0;
                var topProduct = Model.ProductStatistics.OrderByDescending(p => p.Revenue).FirstOrDefault();
                var worstProduct = Model.ProductStatistics.Where(p => p.Profit < 0).OrderBy(p => p.Profit).FirstOrDefault();
            }
            
            @if (aiProfitMargin < 20) {
                <div class="col-md-6 mb-3">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è –ù–∏–∑–∫–∞—è —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (@aiProfitMargin.ToString("F1")%)</strong><br>
                        –†–µ–∫–æ–º–µ–Ω–¥—É—é –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–∞–π—Ç–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ —Å –ª—É—á—à–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏.
                    </div>
                </div>
            }
            
            @if (topProduct != null) {
                <div class="col-md-6 mb-3">
                    <div class="alert alert-success">
                        <strong>üèÜ –õ–∏–¥–µ—Ä –ø—Ä–æ–¥–∞–∂: @topProduct.ProductName</strong><br>
                        –£–≤–µ–ª–∏—á—å—Ç–µ –∑–∞–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ—Ö–æ–∂–∏–µ –º–æ–¥–µ–ª–∏.
                    </div>
                </div>
            }
            
            @if (worstProduct != null) {
                <div class="col-md-6 mb-3">
                    <div class="alert alert-danger">
                        <strong>üìâ –£–±—ã—Ç–æ—á–Ω—ã–π —Ç–æ–≤–∞—Ä: @worstProduct.ProductName</strong><br>
                        –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–∫–∏–¥–∫–∏ –¥–ª—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –∑–∞–∫—É–ø–∫–∏.
                    </div>
                </div>
            }
            
            @if (Model.Statistics.TotalQuantitySold < 50) {
                <div class="col-md-6 mb-3">
                    <div class="alert alert-info">
                        <strong>üìà –ù–∏–∑–∫–∏–µ –ø—Ä–æ–¥–∞–∂–∏</strong><br>
                        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∞–∫—Ü–∏–∏, —Å–∫–∏–¥–∫–∏ –∏–ª–∏ —É–ª—É—á—à–∏—Ç–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é —Ç–æ–≤–∞—Ä–æ–≤.
                    </div>
                </div>
            }
            
            <div class="col-12">
                <div class="alert alert-light border">
                    <strong>üí° –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong>
                    <ul class="mb-0 mt-2">
                        <li>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫—É–ø–æ–∫</li>
                        <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤</li>
                        <li>–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
                        <li>–ò–∑—É—á–∞–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>