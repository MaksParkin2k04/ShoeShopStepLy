@page
@using ShoeShop.Models
@model ShoeShop.Pages.CreatingOrderModel
@{
    ViewData["Title"] = "Оформление заказа";
}

<div class="checkout-page">
    @* Header *@
    <div class="page-header">
        <h1 class="page-title">Оформление заказа</h1>
        <p class="page-subtitle">Заполните данные для доставки и подтвердите заказ</p>
    </div>

    @if (Model.BasketItems == null || Model.BasketItems.Count() == 0) {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-shopping-cart fa-4x"></i>
            </div>
            <h3 class="empty-title">Корзина пуста</h3>
            <p class="empty-text">Добавьте товары в корзину для оформления заказа</p>
            <a asp-page="/Index" class="btn btn-primary btn-lg mt-3">
                <i class="fas fa-arrow-left me-2"></i>
                Вернуться к покупкам
            </a>
        </div>
    } else {
        <div class="checkout-content">
            @* Order Items *@
            <div class="order-summary-section">
                <h3 class="section-title">
                    <i class="fas fa-list me-2"></i>
                    Ваш заказ
                </h3>
                <div class="order-items">
                    @foreach (var item in Model.BasketItems) {
                        <div class="order-item">
                            <div class="order-item-image">
                                @if (item.Product?.Images?.Count > 0) {
                                    <img src="@item.Product.Images[0].Path" alt="@item.Product.Images[0].Alt" class="item-image">
                                } else {
                                    <div class="item-image-placeholder">
                                        <i class="fas fa-image"></i>
                                    </div>
                                }
                            </div>
                            <div class="order-item-info">
                                <h4 class="item-name">
                                    <a asp-page="/Product" asp-route-id="@item.Product?.Id" class="item-link">@item.Product?.Name</a>
                                </h4>
                                <p class="item-description">@item.Product?.Description</p>
                                <p class="item-details">Размер: @item.Size | Количество: @item.Quantity шт.</p>
                            </div>
                            <div class="order-item-price">
                                <span class="item-price">@((item.Product?.Price * item.Quantity) ?? 0) ₽</span>
                            </div>
                        </div>
                    }
                </div>
                @* Промокод *@
                <div class="promo-section mb-3">
                    <h4 class="section-title">Промокод</h4>
                    @if (TempData["PromoSuccess"] != null)
                    {
                        <div class="alert alert-success">@TempData["PromoSuccess"]</div>
                    }
                    @if (TempData["PromoError"] != null)
                    {
                        <div class="alert alert-danger">@TempData["PromoError"]</div>
                    }
                    @if (!string.IsNullOrEmpty(Model.PromoCode))
                    {
                        <div class="alert alert-success d-flex justify-content-between align-items-center">
                            <span>Применен промокод: <strong>@Model.PromoCode</strong></span>
                            <form method="post" asp-page-handler="RemovePromoCode" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <form method="post" asp-page-handler="CheckPromoCode" class="d-flex gap-2">
                            <input name="promoCode" class="form-control" placeholder="Введите промокод" required />
                            <button type="submit" class="btn btn-outline-primary">Применить</button>
                        </form>
                    }
                </div>
                    
                    <div class="order-total">
                        <div class="total-row">
                            <span>Товары (@Model.BasketItems.Sum(p => p.Quantity) шт.)</span>
                            <span>@Model.TotalAmount ₽</span>
                        </div>
                        @if (Model.DiscountAmount > 0)
                        {
                            <div class="total-row text-success">
                                <span>Скидка по промокоду</span>
                                <span>-@Model.DiscountAmount ₽</span>
                            </div>
                        }
                        <div class="total-row">
                            <span>Доставка</span>
                            <span class="delivery-cost" id="deliveryCostDisplay">
                                @if (Model.TotalAmount >= 5000) {
                                    <span class="text-success">Бесплатно</span>
                                } else {
                                    <span>500 ₽</span>
                                }
                            </span>
                        </div>
                        <hr class="total-divider">
                        <div class="total-final">
                            <span>Итого к оплате</span>
                            <span class="final-price" id="finalTotalDisplay">
                                @{
                                    var deliveryCost = Model.TotalAmount >= 5000 ? 0 : 500;
                                    var finalTotal = Model.FinalAmount + deliveryCost;
                                }
                                @finalTotal ₽
                            </span>
                        </div>
                    </div>
                </div>

            @* Delivery Form *@
            <form asp-page="/CreatingOrder" method="post" class="checkout-form">
                <div class="delivery-form-section">
                    @foreach (var item in Model.BasketItems) {
                        <input type="hidden" name="products[]" value="@item.Product?.Id" />
                    }
                    <h3 class="section-title">
                        <i class="fas fa-truck me-2"></i>
                        Данные для доставки
                    </h3>
                    
                    <div class="form-section">
                        <h4 class="form-section-title">Получатель</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name" class="form-label">Имя получателя *</label>
                                <input id="name" name="name" type="text" class="form-control" required placeholder="Введите имя получателя" value="@Model.UserName" />
                            </div>
                            <div class="form-group">
                                <label for="phone" class="form-label">Телефон *</label>
                                <input id="phone" name="phone" type="tel" class="form-control" required placeholder="+7 (999) 123-45-67" value="@Model.UserPhone" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Способ доставки</h4>
                        <div class="delivery-options">
                            <div class="delivery-option">
                                <input type="radio" id="courier" name="deliveryType" value="0" class="delivery-radio" checked>
                                <label for="courier" class="delivery-label">
                                    <div class="delivery-icon">
                                        <i class="fas fa-motorcycle"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <h5>Курьерская доставка</h5>
                                        <p>Доставка по указанному адресу</p>
                                        <span class="delivery-price">500 ₽ (бесплатно от 5000 ₽)</span>
                                    </div>
                                </label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="pickup" name="deliveryType" value="1" class="delivery-radio">
                                <label for="pickup" class="delivery-label">
                                    <div class="delivery-icon">
                                        <i class="fas fa-store"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <h5>Самовывоз</h5>
                                        <p>Забрать в пункте выдачи</p>
                                        <span class="delivery-price">Бесплатно</span>
                                    </div>
                                </label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="russianpost" name="deliveryType" value="2" class="delivery-radio">
                                <label for="russianpost" class="delivery-label">
                                    <div class="delivery-icon">
                                        <i class="fas fa-mail-bulk"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <h5>Почта России</h5>
                                        <p>Доставка почтой (5-10 дней)</p>
                                        <span class="delivery-price">300 ₽</span>
                                    </div>
                                </label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="cdek" name="deliveryType" value="3" class="delivery-radio">
                                <label for="cdek" class="delivery-label">
                                    <div class="delivery-icon">
                                        <i class="fas fa-shipping-fast"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <h5>СДЭК</h5>
                                        <p>Быстрая доставка (1-3 дня)</p>
                                        <span class="delivery-price">400 ₽</span>
                                    </div>
                                </label>
                            </div>
                            <div class="delivery-option">
                                <input type="radio" id="boxberry" name="deliveryType" value="4" class="delivery-radio">
                                <label for="boxberry" class="delivery-label">
                                    <div class="delivery-icon">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <h5>Boxberry</h5>
                                        <p>Доставка в постамат</p>
                                        <span class="delivery-price">350 ₽</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Курьерская доставка -->
                    <div class="form-section delivery-section" id="courier-section">
                        <h4 class="form-section-title">Адрес доставки</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city" class="form-label">Город *</label>
                                <input id="city" name="city" type="text" class="form-control" placeholder="Москва" value="@Model.UserCity" />
                            </div>
                            <div class="form-group">
                                <label for="street" class="form-label">Улица *</label>
                                <input id="street" name="street" type="text" class="form-control" placeholder="ул. Пушкина" value="@Model.UserStreet" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="house" class="form-label">Дом *</label>
                                <input id="house" name="house" type="text" class="form-control" placeholder="д. 10" value="@Model.UserHouse" />
                            </div>
                            <div class="form-group">
                                <label for="apartment" class="form-label">Квартира</label>
                                <input id="apartment" name="apartment" type="text" class="form-control" placeholder="кв. 25" value="@Model.UserApartment" />
                            </div>
                        </div>
                    </div>

                    <!-- Самовывоз -->
                    <div class="form-section delivery-section" id="pickup-section" style="display: none;">
                        <h4 class="form-section-title">Пункт выдачи</h4>
                        <div class="pickup-points">
                            <div class="pickup-point">
                                <input type="radio" id="pickup1" name="pickupPoint" value="Москва, ул. Ленина, 15" class="pickup-radio">
                                <label for="pickup1" class="pickup-label">
                                    <div class="pickup-info">
                                        <h6>Москва, ул. Ленина, 15</h6>
                                        <p>Рабочие дни: 9:00-18:00, Сб-Вс: 10:00-16:00</p>
                                    </div>
                                </label>
                            </div>
                            <div class="pickup-point">
                                <input type="radio" id="pickup2" name="pickupPoint" value="Москва, пр. Мира, 45" class="pickup-radio">
                                <label for="pickup2" class="pickup-label">
                                    <div class="pickup-info">
                                        <h6>Москва, пр. Мира, 45</h6>
                                        <p>Ежедневно: 10:00-20:00</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Почта России -->
                    <div class="form-section delivery-section" id="russianpost-section" style="display: none;">
                        <h4 class="form-section-title">Адрес получателя</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="post-city" class="form-label">Город *</label>
                                <input id="post-city" name="postCity" type="text" class="form-control" placeholder="Москва" value="@Model.UserCity" />
                            </div>
                            <div class="form-group">
                                <label for="post-index" class="form-label">Почтовый индекс *</label>
                                <input id="post-index" name="postIndex" type="text" class="form-control" placeholder="123456" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="post-address" class="form-label">Полный адрес *</label>
                            <input id="post-address" name="postAddress" type="text" class="form-control" placeholder="ул. Пушкина, д. 10, кв. 25" />
                        </div>
                    </div>

                    <!-- СДЭК -->
                    <div class="form-section delivery-section" id="cdek-section" style="display: none;">
                        <h4 class="form-section-title">Пункт выдачи СДЭК</h4>
                        <div class="form-group">
                            <label for="cdek-city" class="form-label">Город *</label>
                            <select id="cdek-city" name="cdekCity" class="form-control">
                                <option value="">Выберите город</option>
                                <option value="Москва">Москва</option>
                                <option value="СПб">СПб</option>
                                <option value="Новосибирск">Новосибирск</option>
                                <option value="Екатеринбург">Екатеринбург</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="cdek-point" class="form-label">Пункт выдачи *</label>
                            <select id="cdek-point" name="cdekPoint" class="form-control">
                                <option value="">Сначала выберите город</option>
                            </select>
                        </div>
                    </div>

                    <!-- Boxberry -->
                    <div class="form-section delivery-section" id="boxberry-section" style="display: none;">
                        <h4 class="form-section-title">Постамат Boxberry</h4>
                        <div class="form-group">
                            <label for="boxberry-city" class="form-label">Город *</label>
                            <select id="boxberry-city" name="boxberryCity" class="form-control">
                                <option value="">Выберите город</option>
                                <option value="Москва">Москва</option>
                                <option value="СПб">СПб</option>
                                <option value="Новосибирск">Новосибирск</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="boxberry-point" class="form-label">Постамат *</label>
                            <select id="boxberry-point" name="boxberryPoint" class="form-control">
                                <option value="">Сначала выберите город</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Дополнительно</h4>
                        <div class="form-group">
                            <label for="coment" class="form-label">Комментарий к заказу</label>
                            <textarea id="coment" name="coment" class="form-control" rows="3" placeholder="Укажите дополнительные пожелания к заказу..."></textarea>
                        </div>
                    </div>

                    @* Скрытые поля для промокода *@
                    <input type="hidden" name="PromoCode" id="hiddenPromoCode" value="" />
                    <input type="hidden" name="DiscountAmount" id="hiddenDiscountAmount" value="0" />
                    
                    <div class="form-actions">
                        <a asp-page="/BasketShopping" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>
                            Вернуться в корзину
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-check me-2"></i>
                            Подтвердить заказ
                        </button>
                    </div>
                </div>
            </form>
        </div>
    }
</div>

<style>
.delivery-options {
    display: grid;
    gap: 15px;
    margin-bottom: 20px;
}

.delivery-option {
    position: relative;
}

.delivery-radio {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.delivery-label {
    display: flex;
    align-items: center;
    padding: 20px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    gap: 15px;
}

.delivery-label:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.delivery-radio:checked + .delivery-label {
    border-color: #007bff;
    background: #f8f9ff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.delivery-icon {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    background: #f8f9fa;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #6c757d;
    transition: all 0.3s ease;
}

.delivery-radio:checked + .delivery-label .delivery-icon {
    background: #007bff;
    color: white;
}

.delivery-info {
    flex-grow: 1;
}

.delivery-info h5 {
    margin: 0 0 5px 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.delivery-info p {
    margin: 0 0 8px 0;
    color: #666;
    font-size: 0.9rem;
}

.delivery-price {
    font-weight: 600;
    color: #007bff;
    font-size: 0.95rem;
}

.delivery-section {
    display: none;
}

.delivery-section.active {
    display: block;
}

.pickup-points {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.pickup-point {
    position: relative;
}

.pickup-radio {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.pickup-label {
    display: block;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.pickup-label:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.pickup-radio:checked + .pickup-label {
    border-color: #007bff;
    background: #f8f9ff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.pickup-info h6 {
    margin: 0 0 5px 0;
    font-weight: 600;
    color: #333;
}

.pickup-info p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

@@media (max-width: 768px) {
    .delivery-label {
        padding: 15px;
        gap: 12px;
    }
    
    .delivery-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .delivery-info h5 {
        font-size: 1rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliveryRadios = document.querySelectorAll('input[name="deliveryType"]');
    const deliveryCostDisplay = document.getElementById('deliveryCostDisplay');
    const finalTotalDisplay = document.getElementById('finalTotalDisplay');
    const addressSection = document.querySelector('.address-section');
    
    const baseTotal = @Model.FinalAmount;
    const freeDeliveryThreshold = 5000;
    const totalAmount = @Model.TotalAmount;
    
    const deliveryCosts = {
        '0': totalAmount >= freeDeliveryThreshold ? 0 : 500, // Курьер
        '1': 0,   // Самовывоз
        '2': 300, // Почта России
        '3': 400, // СДЭК
        '4': 350  // Boxberry
    };
    
    function updateDeliveryCost() {
        const selectedDelivery = document.querySelector('input[name="deliveryType"]:checked');
        if (!selectedDelivery) return;
        
        const deliveryType = selectedDelivery.value;
        const deliveryCost = deliveryCosts[deliveryType];
        const finalTotal = baseTotal + deliveryCost;
        
        // Обновляем отображение стоимости доставки
        if (deliveryCost === 0) {
            deliveryCostDisplay.innerHTML = '<span class="text-success">Бесплатно</span>';
        } else {
            deliveryCostDisplay.innerHTML = `<span>${deliveryCost} ₽</span>`;
        }
        
        // Обновляем итоговую сумму
        finalTotalDisplay.textContent = `${finalTotal} ₽`;
        
        // Показываем/скрываем соответствующие секции
        const sections = {
            '0': 'courier-section',     // Курьер
            '1': 'pickup-section',      // Самовывоз
            '2': 'russianpost-section', // Почта России
            '3': 'cdek-section',        // СДЭК
            '4': 'boxberry-section'     // Boxberry
        };
        
        // Скрываем все секции
        document.querySelectorAll('.delivery-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Показываем нужную секцию
        const targetSection = document.getElementById(sections[deliveryType]);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Обновляем required атрибуты
        updateRequiredFields(deliveryType);
    }
    
    function updateRequiredFields(deliveryType) {
        // Убираем required со всех полей
        document.querySelectorAll('.delivery-section input, .delivery-section select').forEach(field => {
            field.removeAttribute('required');
        });
        
        // Добавляем required к активным полям
        const activeSection = document.querySelector('.delivery-section.active');
        if (activeSection) {
            activeSection.querySelectorAll('input[type="text"], input[type="radio"]:not(.pickup-radio), select').forEach(field => {
                if (field.type === 'radio') {
                    // Для радио кнопок добавляем required только к первой в группе
                    const groupName = field.name;
                    const firstInGroup = activeSection.querySelector(`input[name="${groupName}"]`);
                    if (field === firstInGroup) {
                        field.setAttribute('required', 'required');
                    }
                } else {
                    field.setAttribute('required', 'required');
                }
            });
        }
    }
    
    deliveryRadios.forEach(radio => {
        radio.addEventListener('change', updateDeliveryCost);
    });
    
    // Обработчики для выбора городов
    document.getElementById('cdek-city').addEventListener('change', function() {
        const city = this.value;
        const pointSelect = document.getElementById('cdek-point');
        pointSelect.innerHTML = '<option value="">Выберите пункт выдачи</option>';
        
        if (city === 'Москва') {
            pointSelect.innerHTML += '<option value="Москва, ул. Тверская, 10">ул. Тверская, 10</option>';
            pointSelect.innerHTML += '<option value="Москва, пр. Мира, 25">пр. Мира, 25</option>';
        } else if (city === 'СПб') {
            pointSelect.innerHTML += '<option value="СПб, Невский пр., 50">Невский пр., 50</option>';
            pointSelect.innerHTML += '<option value="СПб, ул. Рубинштейна, 15">ул. Рубинштейна, 15</option>';
        }
    });
    
    document.getElementById('boxberry-city').addEventListener('change', function() {
        const city = this.value;
        const pointSelect = document.getElementById('boxberry-point');
        pointSelect.innerHTML = '<option value="">Выберите постамат</option>';
        
        if (city === 'Москва') {
            pointSelect.innerHTML += '<option value="Москва, м. Сокольники">м. Сокольники</option>';
            pointSelect.innerHTML += '<option value="Москва, м. Парк Культуры">м. Парк Культуры</option>';
        } else if (city === 'СПб') {
            pointSelect.innerHTML += '<option value="СПб, м. Гостиный двор">м. Гостиный двор</option>';
            pointSelect.innerHTML += '<option value="СПб, м. Технологический">м. Технологический</option>';
        }
    });
    
    // Инициализация
    updateDeliveryCost();
});
</script>