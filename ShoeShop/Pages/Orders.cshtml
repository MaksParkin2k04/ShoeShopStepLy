@page
@using ShoeShop.Models
@model ShoeShop.Pages.OrdersModel
@{
    ViewData["Title"] = "Мои заказы";
    
    Dictionary<string, string> statusFilterDictionary = new Dictionary<string, string>(new KeyValuePair<string, string>[] {
        new KeyValuePair<string, string>("Аll", "Все"),
        new KeyValuePair<string, string>("Created", "Созданные"),
        new KeyValuePair<string, string>("Processing", "В обработке"),
        new KeyValuePair<string, string>("Completed", "Выполненные"),
        new KeyValuePair<string, string>("Canceled", "Отмененные")
    });

    Dictionary<string, string> orderSortingDictionary = new Dictionary<string, string>(new KeyValuePair<string, string>[] {
        new KeyValuePair<string, string>("ByDateDesc", "Сначала новые"),
        new KeyValuePair<string, string>("ByDateAsc", "Сначала старые")
    });
}

<div class="orders-page">
    @* Header *@
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-receipt me-3"></i>
            Мои заказы
        </h1>
        <p class="page-subtitle">История ваших покупок и текущие заказы</p>
    </div>

    @* Stats *@
    <div class="orders-stats">
        <div class="stat-item">
            <div class="stat-number">@(Model.Orders?.Count() ?? 0)</div>
            <div class="stat-label">Всего заказов</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">@(Model.Orders?.Count(o => o.Status == OrderStatus.Processing) ?? 0)</div>
            <div class="stat-label">В обработке</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">@(Model.Orders?.Count(o => o.Status == OrderStatus.Completed) ?? 0)</div>
            <div class="stat-label">Выполнено</div>
        </div>
    </div>

    @* Filters *@
    <div class="orders-filters">
        <form id="sortingForm" asp-page="/Orders" method="get" class="filters-form">
            <div class="filter-group">
                <label class="filter-label">Статус:</label>
                <select id="filterStatus" name="filter" class="form-select" onchange="document.getElementById('sortingForm').submit()">
                    @foreach (string key in statusFilterDictionary.Keys) {
                        if (key == Model.Filter.ToString()) {
                            <option value="@key" selected>@statusFilterDictionary[key]</option>
                        } else {
                            <option value="@key">@statusFilterDictionary[key]</option>
                        }
                    }
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Сортировка:</label>
                <select id="sorting" name="sorting" class="form-select" onchange="document.getElementById('sortingForm').submit()">
                    @foreach (string key in orderSortingDictionary.Keys) {
                        if (key == Model.Sorting.ToString()) {
                            <option value="@key" selected>@orderSortingDictionary[key]</option>
                        } else {
                            <option value="@key">@orderSortingDictionary[key]</option>
                        }
                    }
                </select>
            </div>
        </form>
    </div>

    @* Orders List *@
    <div class="orders-content">
        @if (Model.Orders == null || Model.Orders.Count() == 0) {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-receipt fa-4x"></i>
                </div>
                <h3 class="empty-title">У вас пока нет заказов</h3>
                <p class="empty-text">Начните покупки в нашем каталоге</p>
                <a asp-page="/Index" class="btn btn-primary btn-lg mt-3">
                    <i class="fas fa-shopping-bag me-2"></i>
                    Перейти к покупкам
                </a>
            </div>
        } else {
            <div class="orders-list">
                @foreach (Order order in Model.Orders) {
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-info">
                                <h4 class="order-number">
                                    <a asp-page="Order" asp-route-orderId="@order.Id" class="order-link">
                                        Заказ #@order.Id.ToString().Substring(0, 8)
                                    </a>
                                </h4>
                                <div class="order-date">
                                    <i class="fas fa-calendar me-1"></i>
                                    @order.CreatedDate.ToString("dd.MM.yyyy в HH:mm")
                                </div>
                            </div>
                            <div class="order-status-section">
                                <span class="status-badge status-@order.Status.ToString().ToLower()">
                                    @switch (order.Status) {
                                        case OrderStatus.Created:
                                            <i class="fas fa-plus-circle me-1"></i>
                                            <span>Создан</span>
                                            break;
                                        case OrderStatus.Paid:
                                            <i class="fas fa-credit-card me-1"></i>
                                            <span>Оплачен</span>
                                            break;
                                        case OrderStatus.Processing:
                                            <i class="fas fa-cogs me-1"></i>
                                            <span>В обработке</span>
                                            break;
                                        case OrderStatus.AwaitingShipment:
                                            <i class="fas fa-clock me-1"></i>
                                            <span>Ожидает отправления</span>
                                            break;
                                        case OrderStatus.Shipped:
                                            <i class="fas fa-shipping-fast me-1"></i>
                                            <span>Отправлен</span>
                                            break;
                                        case OrderStatus.InTransit:
                                            <i class="fas fa-truck me-1"></i>
                                            <span>В пути</span>
                                            break;
                                        case OrderStatus.Arrived:
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            <span>Прибыл</span>
                                            break;
                                        case OrderStatus.ReadyForPickup:
                                            <i class="fas fa-hand-paper me-1"></i>
                                            <span>Готов к выдаче</span>
                                            break;
                                        case OrderStatus.Completed:
                                            <i class="fas fa-check-circle me-1"></i>
                                            <span>Выполнен</span>
                                            break;
                                        case OrderStatus.Returned:
                                            <i class="fas fa-undo me-1"></i>
                                            <span>Возвращен</span>
                                            break;
                                        case OrderStatus.Canceled:
                                            <i class="fas fa-times-circle me-1"></i>
                                            <span>Отменен</span>
                                            break;
                                    }
                                </span>
                                <div class="payment-status mt-2">
                                    @if (order.PaymentDate.HasValue || order.Status == OrderStatus.Paid)
                                    {
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Оплачено
                                        </span>
                                    }
                                    else
                                    {
                                        @if (order.PaymentType == PaymentType.Online)
                                        {
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Ожидает оплаты
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info">
                                                <i class="fas fa-money-bill me-1"></i>Оплата при получении
                                            </span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-details">
                            <div class="delivery-info">
                                <div class="delivery-item">
                                    <i class="fas fa-user me-2"></i>
                                    <span>@order.Recipient?.Name</span>
                                </div>
                                <div class="delivery-item">
                                    <i class="fas fa-phone me-2"></i>
                                    <span>@order.Recipient?.Phone</span>
                                </div>
                                <div class="delivery-item">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span>@order.Recipient?.City, @order.Recipient?.Street, @order.Recipient?.House</span>
                                </div>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(order.Coment)) {
                                <div class="order-comment">
                                    <i class="fas fa-comment me-2"></i>
                                    <span>@order.Coment</span>
                                </div>
                            }
                        </div>
                        
                        <div class="order-footer">
                            <div class="order-items-count">
                                <i class="fas fa-box me-1"></i>
                                Товаров: @order.OrderDetails.Count
                            </div>
                            <div class="order-actions">
                                <a asp-page="Order" asp-route-orderId="@order.Id" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>
                                    Подробнее
                                </a>
                                @if (order.PaymentDate.HasValue || order.Status == OrderStatus.Paid)
                                {
                                    <a href="/Receipt/@order.Id" target="_blank" class="btn btn-success btn-sm ms-2">
                                        <i class="fas fa-receipt me-1"></i>
                                        Чек
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    @* Pagination *@
    <div class="orders-pagination">
        @await Component.InvokeAsync(typeof(ShoeShop.Paginations.Components.PaginationViewComponent), new {
                currentPage = Model.CurrentPage,
                elementsPerPage = Model.ElementsPerPage,
                totalElementsCount = Model.TotalElementsCount,
                page = "/Orders",
                routeData = new Dictionary<string, string>([
                    new KeyValuePair<string, string>("sorting", Model.Sorting.ToString()), 
                    new KeyValuePair<string, string>("filter", Model.Filter.ToString())
                ])
            })
    </div>
</div>