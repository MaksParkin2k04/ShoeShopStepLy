@page "/Product/{id:guid}"
@using ShoeShop.Models
@using ShoeShop.Services
@model ShoeShop.Pages.ProductModel
@{
    ViewData["Title"] = Model.Product?.Name;
}

@if (Model.Product == null) {
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-search fa-4x"></i>
        </div>
        <h3 class="empty-title">Товар не найден</h3>
        <p class="empty-text">Возможно, товар был удален или перемещен</p>
        <a asp-page="/Index" class="btn btn-primary mt-3">Вернуться к каталогу</a>
    </div>
} else {
    <div class="product-detail">
        @* Breadcrumb *@
        <nav class="breadcrumb-nav mb-4">
            <a asp-page="/Index" class="breadcrumb-link">Главная</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">@Model.Product.Name</span>
        </nav>

        @if (TempData["Error"] != null) {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="row g-5">
            @* Product Images *@
            <div class="col-lg-6">
                <div class="product-gallery">
                    @if (Model.Product.Images?.Count > 0) {
                        <div id="productCarousel" class="carousel slide" data-bs-ride="false">
                            <div class="carousel-inner">
                                @for (int i = 0; i < Model.Product.Images.Count; i++) {
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <img src="@Model.Product.Images[i].Path" class="gallery-main-image" alt="@Model.Product.Images[i].Alt">
                                    </div>
                                }
                            </div>
                            @if (Model.Product.Images.Count > 1) {
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            }
                        </div>
                        @if (Model.Product.Images.Count > 1) {
                            <div class="gallery-thumbnails">
                                @for (int i = 0; i < Model.Product.Images.Count; i++) {
                                    <img src="@Model.Product.Images[i].Path" class="gallery-thumb @(i == 0 ? "active" : "")" 
                                         data-bs-target="#productCarousel" data-bs-slide-to="@i" alt="@Model.Product.Images[i].Alt">
                                }
                            </div>
                        }
                    } else {
                        <div class="gallery-placeholder">
                            <i class="fas fa-image fa-4x"></i>
                            <p>Изображение недоступно</p>
                        </div>
                    }
                </div>
            </div>

            @* Product Info *@
            <div class="col-lg-6">
                <div class="product-info-detail">
                    <h1 class="product-title-detail">@Model.Product.Name</h1>
                    
                    @if (Model.ReviewCount > 0) {
                        <div class="product-rating mb-3">
                            <div class="stars">
                                @for (int i = 1; i <= 5; i++) {
                                    if (i <= Math.Round(Model.AverageRating)) {
                                        <i class="fas fa-star text-warning"></i>
                                    } else {
                                        <i class="far fa-star text-muted"></i>
                                    }
                                }
                            </div>
                            <span class="rating-text">@Model.AverageRating.ToString("F1") (@Model.ReviewCount отзыв@(Model.ReviewCount % 10 == 1 && Model.ReviewCount % 100 != 11 ? "" : Model.ReviewCount % 10 >= 2 && Model.ReviewCount % 10 <= 4 && (Model.ReviewCount % 100 < 10 || Model.ReviewCount % 100 >= 20) ? "а" : "ов"))</span>
                        </div>
                    }
                    
                    <p class="product-description-detail">@Model.Product.Description</p>
                    
                    @if (Model.Product.Category != null) {
                        <div class="product-category mb-3">
                            <span class="badge bg-secondary">@Model.Product.Category.Name</span>
                        </div>
                    }
                    
                    <div class="product-price-section">
                        @if (Model.Product.HasDiscount) {
                            <span class="product-price-old">@Model.Product.Price ₽</span>
                            <span class="product-price-detail">@Model.Product.SalePrice ₽</span>
                            <span class="product-discount-badge">Скидка</span>
                        } else {
                            <span class="product-price-detail">@Model.Product.Price ₽</span>
                        }
                        <span class="product-price-label">за пару</span>
                    </div>

                    <div class="product-content">
                        <h4>Описание</h4>
                        <div class="content-text">@Model.Product.Content</div>
                    </div>

                    <form asp-page="/Product" method="post" class="add-to-cart-form" onsubmit="return validateSize()">
                        <input type="hidden" name="productId" value="@Model.Product.Id" />
                        
                        @if (Model.Product.Sizes != ProductSize.Not) {
                            <div class="product-sizes mb-4">
                                <h5>Выберите размер:</h5>
                                <div class="sizes-list">
                                    @for (int size = 36; size <= 45; size++) {
                                        var sizeFlag = (ProductSize)(1UL << (size - 1));
                                        if (Model.Product.Sizes.HasFlag(sizeFlag)) {
                                            var quantity = Model.SizeQuantities.GetValueOrDefault(size, 0);
                                            var isAvailable = quantity > 0;
                                            <input type="radio" name="selectedSize" value="@size" id="size@(size)" class="size-radio" @(!isAvailable ? "disabled" : "") data-quantity="@quantity" onchange="updateSizeInfo(@size, @quantity)" required>
                                            <label for="size@(size)" class="size-badge @(!isAvailable ? "disabled" : "")">@size</label>
                                        }
                                    }
                                </div>
                                <div id="size-info" class="size-info mt-3" style="display: none;">
                                    <div class="alert" id="size-alert"></div>
                                </div>
                            </div>
                        }
                        
                        @if (Model.AvailabilityStatus != ProductAvailabilityStatus.OutOfStock) {
                            <button type="submit" class="btn btn-primary btn-lg add-to-cart-btn">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Добавить в корзину
                            </button>
                        } else {
                            <button type="button" class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-times me-2"></i>
                                Нет в наличии
                            </button>
                        }
                    </form>

                    <script>
                        function validateSize() {
                            const selectedSize = document.querySelector('input[name="selectedSize"]:checked');
                            if (!selectedSize) {
                                alert('Пожалуйста, выберите размер');
                                return false;
                            }
                            return true;
                        }

                        function updateSizeInfo(size, quantity) {
                            const sizeInfo = document.getElementById('size-info');
                            const sizeAlert = document.getElementById('size-alert');
                            
                            if (quantity === 0) {
                                sizeAlert.className = 'alert alert-danger';
                                sizeAlert.innerHTML = '<i class="fas fa-times-circle me-2"></i>Размер ' + size + ' недоступен';
                                sizeInfo.style.display = 'block';
                            } else if (quantity < 5) {
                                sizeAlert.className = 'alert alert-warning';
                                sizeAlert.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Размер ' + size + ': осталось мало';
                                sizeInfo.style.display = 'block';
                            } else {
                                sizeAlert.className = 'alert alert-success';
                                sizeAlert.innerHTML = '<i class="fas fa-check-circle me-2"></i>Размер ' + size + ' в наличии';
                                sizeInfo.style.display = 'block';
                            }
                        }
                    </script>

                    <style>
                    .product-price-section {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin: 20px 0;
                    }
                    
                    .product-price-old {
                        font-size: 1.2em;
                        color: #999;
                        text-decoration: line-through;
                    }
                    
                    .product-price-detail {
                        font-size: 1.8em;
                        font-weight: bold;
                        color: #333;
                    }
                    
                    .product-discount-badge {
                        background: #dc3545;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 0.8em;
                        font-weight: bold;
                    }
                    
                    .product-price-label {
                        color: #666;
                        font-size: 0.9em;
                    }
                    
                    .product-rating {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    
                    .rating-input {
                        display: flex;
                        flex-direction: row-reverse;
                        gap: 5px;
                    }
                    
                    .rating-input input {
                        display: none;
                    }
                    
                    .star-label {
                        font-size: 2em;
                        color: #ddd;
                        cursor: pointer;
                        transition: color 0.2s;
                    }
                    
                    .rating-input input:checked ~ .star-label,
                    .rating-input input:hover ~ .star-label,
                    .star-label:hover {
                        color: #ffc107;
                    }
                    
                    .review-item {
                        border: 1px solid #eee;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 15px;
                    }
                    
                    .review-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 10px;
                    }
                    
                    .review-author {
                        font-weight: bold;
                    }
                    
                    .review-date {
                        color: #666;
                        font-size: 0.9em;
                    }
                    
                    .review-comment {
                        color: #333;
                        line-height: 1.5;
                    }
                    
                    .admin-reply {
                        margin-top: 15px;
                        padding: 10px;
                        background-color: #f8f9fa;
                        border-left: 3px solid #007bff;
                        border-radius: 4px;
                    }
                    
                    .reply-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 8px;
                    }
                    
                    .reply-text {
                        color: #495057;
                        line-height: 1.4;
                    }
                    
                    .admin-reply-form {
                        margin-top: 10px;
                        padding: 10px;
                        background-color: #fff3cd;
                        border-radius: 4px;
                        border: 1px solid #ffeaa7;
                    }
                    </style>

                    @if (User.IsInRole("Admin")) {
                        <div class="admin-section mt-4 p-3 border rounded bg-light">
                            <h6>Админ панель</h6>
                            <div class="mb-3">
                                <strong>Печать этикеток по размерам:</strong>
                                <div class="mt-2">
                                    @for (int size = 36; size <= 45; size++) {
                                        var sizeFlag = (ProductSize)(1UL << (size - 1));
                                        if (Model.Product.Sizes.HasFlag(sizeFlag)) {
                                            <a asp-page="/ProductSizeLabel" asp-route-productId="@Model.Product.Id" asp-route-size="@size" 
                                               class="btn btn-sm btn-outline-success me-1 mb-1" target="_blank" title="Печать этикетки размер @size">
                                                @size
                                            </a>
                                        }
                                    }
                                </div>
                            </div>
                            <div>
                                <a asp-page="/ProductLabel" asp-route-productId="@Model.Product.Id" 
                                   class="btn btn-sm btn-outline-primary" target="_blank" title="Печать общей этикетки">
                                    <i class="fas fa-print me-1"></i>Общая этикетка
                                </a>
                            </div>
                        </div>
                    }

                    <div class="product-features">
                        <div class="feature-item">
                            <i class="fas fa-truck"></i>
                            <span>Бесплатная доставка от 5000 ₽</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-undo"></i>
                            <span>Возврат в течение 30 дней</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Гарантия качества</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        @* Reviews Section *@
        <div class="row mt-5">
            <div class="col-12">
                <div class="reviews-section">
                    <h3>Отзывы</h3>
                    
                    @if (User.Identity.IsAuthenticated && Model.CanReview) {
                        <div class="add-review-form mb-4">
                            <h5>Оставить отзыв</h5>
                            <form method="post" asp-page-handler="AddReview">
                                <input type="hidden" name="productId" value="@Model.Product.Id" />
                                <div class="mb-3">
                                    <label class="form-label">Оценка</label>
                                    <div class="rating-input">
                                        @for (int i = 5; i >= 1; i--) {
                                            <input type="radio" name="rating" value="@i" id="star@(i)" required>
                                            <label for="star@(i)" class="star-label">★</label>
                                        }
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Комментарий</label>
                                    <textarea name="comment" class="form-control" rows="3" maxlength="1000" placeholder="Поделитесь своим мнением о товаре"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Добавить отзыв</button>
                            </form>
                        </div>
                    } else if (User.Identity.IsAuthenticated && !Model.CanReview) {
                        <div class="alert alert-warning mb-4">
                            Отзывы могут оставлять только покупатели, которые получили этот товар
                        </div>
                    } else {
                        <div class="alert alert-info mb-4">
                            <a asp-page="/Account/Login">Войдите</a> или <a asp-page="/Account/Register">зарегистрируйтесь</a>, чтобы оставить отзыв
                        </div>
                    }
                    
                    @if (Model.Reviews.Any()) {
                        <div class="reviews-list">
                            @foreach (var review in Model.Reviews) {
                                <div class="review-item">
                                    <div class="review-header">
                                        <div class="review-author">@review.User?.UserName</div>
                                        <div class="review-rating">
                                            @for (int i = 1; i <= 5; i++) {
                                                if (i <= review.Rating) {
                                                    <i class="fas fa-star text-warning"></i>
                                                } else {
                                                    <i class="far fa-star text-muted"></i>
                                                }
                                            }
                                        </div>
                                        <div class="review-date">@review.CreatedAt.ToString("dd.MM.yyyy")</div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(review.Comment)) {
                                        <div class="review-comment">@review.Comment</div>
                                    }
                                    
                                    @{
                                        var reply = Model.ReviewReplies.GetValueOrDefault(review.Id);
                                    }
                                    @if (reply != null) {
                                        <div class="admin-reply">
                                            <div class="reply-header">
                                                <strong>Ответ администратора:</strong>
                                                <small class="text-muted">@reply.CreatedAt.ToString("dd.MM.yyyy")</small>
                                            </div>
                                            <div class="reply-text">@reply.Reply</div>
                                        </div>
                                    } else if (User.IsInRole("Admin")) {
                                        <div class="admin-reply-form">
                                            <form method="post" asp-page-handler="AddReply">
                                                <input type="hidden" name="productId" value="@Model.Product.Id" />
                                                <input type="hidden" name="reviewId" value="@review.Id" />
                                                <div class="mb-2">
                                                    <textarea name="reply" class="form-control form-control-sm" rows="2" placeholder="Ответить на отзыв..." maxlength="1000" required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-sm btn-outline-primary">Ответить</button>
                                            </form>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    } else {
                        <p class="text-muted">Пока нет отзывов. Будьте первым!</p>
                    }
                </div>
            </div>
        </div>
    </div>
}