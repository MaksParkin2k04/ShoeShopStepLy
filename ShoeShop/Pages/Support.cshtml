@page
@model ShoeShop.Pages.SupportModel
@{
    ViewData["Title"] = "Поддержка";
}

<div class="hero-section">
    <div class="hero-content">
        <div class="hero-badge">Поддержка</div>
        <h1 class="hero-title">Служба поддержки</h1>
        <p class="hero-subtitle">Мы поможем вам с любыми вопросами о товарах, заказах и доставке</p>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card chat-card">
                <div class="chat-header">
                    <div>
                        <h5 class="mb-1">
                            <i class="fas fa-headset me-2"></i>
                            Служба поддержки StepLy
                        </h5>
                        <small class="text-muted">
                            <span class="status-dot me-1"></span>
                            Мы онлайн • Обычно отвечаем в течение 2-5 минут
                        </small>
                    </div>
                    @if (Model.Messages.Any(m => !m.IsAnswered && !m.IsClosed))
                    {
                        <form method="post" asp-page-handler="CloseChat" class="d-inline">
                            <button type="submit" class="btn btn-outline-secondary btn-sm" title="Закрыть чат">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                    }
                </div>
                
                <div class="chat-container" id="chat-container">
                    @if (Model.Messages.Any())
                    {
                        @foreach (var message in Model.Messages)
                        {
                            <div class="message-group mb-3">
                                @if (message.UserName == "Система")
                                {
                                    <!-- Системное сообщение -->
                                    <div class="d-flex justify-content-center mb-2">
                                        <div class="system-message rounded p-3 text-center" style="max-width: 80%;">
                                            <div class="fw-bold mb-1">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Системное сообщение
                                            </div>
                                            <div>@Html.Raw(message.Message.Replace("\n", "<br>"))</div>
                                            <small class="opacity-75 d-block mt-1">@message.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(message.RespondedBy) && message.RespondedBy != "Бот")
                                {
                                    <!-- Сообщение от администратора -->
                                    <div class="d-flex justify-content-start mb-2">
                                        <div class="admin-message rounded p-3" style="max-width: 70%;">
                                            <div class="fw-bold mb-1">
                                                <i class="fas fa-user-tie me-1"></i>
                                                @message.RespondedBy
                                            </div>
                                            <div>@Html.Raw(message.Message.Replace("\n", "<br>"))</div>
                                            <small class="opacity-75 d-block mt-1">@message.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <!-- Сообщение пользователя -->
                                    <div class="d-flex justify-content-end mb-2">
                                        <div class="user-message rounded p-3" style="max-width: 70%;">
                                            <div>@message.Message</div>
                                            <small class="opacity-75 d-block mt-1">@message.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                        </div>
                                    </div>

                                    <!-- Ответ бота или консультанта -->
                                    @if (!string.IsNullOrEmpty(message.Response))
                                    {
                                        <div class="d-flex justify-content-start">
                                            <div class="consultant-message rounded p-3" style="max-width: 70%;">
                                                <div class="fw-bold mb-1">
                                                    @if (message.RespondedBy == "Бот")
                                                    {
                                                        <i class="fas fa-robot me-1"></i>
                                                        @("Виртуальный консультант")
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-user-tie me-1"></i>
                                                        @(message.RespondedBy ?? "Консультант")
                                                    }
                                                </div>
                                                <div>@Html.Raw(message.Response.Replace("\n", "<br>"))</div>
                                                <small class="text-muted d-block mt-1">@message.RespondedAt?.ToString("dd.MM.yyyy HH:mm")</small>
                                            </div>
                                        </div>
                                    }
                                    else if (!message.IsAnswered)
                                    {
                                        <div class="d-flex justify-content-start">
                                            <div class="waiting-message rounded p-2" style="max-width: 70%;">
                                                <small>
                                                    <i class="fas fa-clock me-1"></i>
                                                    Ожидает ответа консультанта...
                                                </small>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x mb-3 text-muted"></i>
                            <h5>Добро пожаловать в службу поддержки!</h5>
                            <p class="text-muted">Задайте любой вопрос, и наш консультант ответит вам в ближайшее время.</p>
                            <div class="row mt-4">
                                <div class="col-md-4 mb-3">
                                    <div class="card quick-card" onclick="sendQuickMessage('Расскажите о доставке')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-shipping-fast mb-3 fa-2x"></i>
                                            <div class="fw-bold mb-1">Доставка</div>
                                            <small class="text-muted">Сроки и стоимость</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card quick-card" onclick="sendQuickMessage('Таблица размеров')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-shoe-prints mb-3 fa-2x"></i>
                                            <div class="fw-bold mb-1">Размеры</div>
                                            <small class="text-muted">Подбор размера</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card quick-card" onclick="sendQuickMessage('Способы оплаты')">
                                        <div class="card-body text-center">
                                            <i class="fas fa-credit-card mb-3 fa-2x"></i>
                                            <div class="fw-bold mb-1">Оплата</div>
                                            <small class="text-muted">Способы оплаты</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="chat-input-section">
                    <form method="post" asp-page-handler="SendMessage" id="message-form">
                        <div class="input-group">
                            <input type="text" name="message" class="form-control" 
                                   placeholder="Напишите ваш вопрос..." required id="message-input" />
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Быстрые вопросы -->
        <div class="col-lg-10 mt-4">
            <h6 class="mb-3">Часто задаваемые вопросы:</h6>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('Как узнать свой размер обуви?')">
                        Как узнать свой размер?
                    </button>
                </div>
                <div class="col-md-6 mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('Сколько стоит доставка?')">
                        Стоимость доставки
                    </button>
                </div>
                <div class="col-md-6 mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('Как оформить возврат товара?')">
                        Возврат товара
                    </button>
                </div>
                <div class="col-md-6 mb-2">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="sendQuickMessage('Какие способы оплаты доступны?')">
                        Способы оплаты
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function sendQuickMessage(message) {
            document.getElementById('message-input').value = message;
            document.getElementById('message-form').submit();
        }

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('message-form').submit();
            }
        });

        setInterval(function() {
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContainer = doc.getElementById('chat-container');
                    if (newContainer) {
                        const currentContainer = document.getElementById('chat-container');
                        const wasAtBottom = currentContainer.scrollTop >= currentContainer.scrollHeight - currentContainer.clientHeight - 50;
                        
                        currentContainer.innerHTML = newContainer.innerHTML;
                        
                        if (wasAtBottom) {
                            scrollToBottom();
                        }
                    }
                })
                .catch(error => console.error('Ошибка обновления чата:', error));
        }, 10000);

        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
        });
    </script>
}

<style>
    .chat-card {
        margin-bottom: 2rem;
    }
    
    .chat-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e1e1e1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-container {
        height: 500px;
        overflow-y: auto;
        padding: 1.5rem;
        background: var(--accent);
    }
    
    .chat-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .chat-container::-webkit-scrollbar-thumb {
        background: var(--secondary);
        border-radius: 3px;
    }
    
    .user-message {
        background: var(--primary);
        color: var(--white);
        margin-left: auto;
    }
    
    .consultant-message {
        background: var(--white);
        border: 1px solid #e1e1e1;
        color: var(--primary);
    }
    
    .admin-message {
        background: #28a745;
        color: var(--white);
    }
    
    .waiting-message {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }
    
    .system-message {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        font-style: italic;
    }
    
    .message-group {
        animation: slideIn 0.3s ease;
    }
    
    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .chat-input-section {
        padding: 1.5rem;
        border-top: 1px solid #e1e1e1;
        background: var(--white);
    }
    
    .quick-card {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .quick-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
    }
    
    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
</style>